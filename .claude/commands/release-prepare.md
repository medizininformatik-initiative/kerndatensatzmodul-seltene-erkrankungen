# Release Preparation Command

You are helping prepare a new release for the MII Seltene Erkrankungen module following the official MII Module Release Workflow.

## Usage

```
/release-prepare <VERSION>
```

Example: `/release-prepare 2026.0.0-rc.2`

The VERSION parameter is optional. If not provided, ask the user for it.

## Your Task

Execute Phase 1-5 of the MII Module Release Workflow (automated preparation through PR creation):

### Phase 1: Create Release Branch
1. Check current git status - ensure working tree is clean
2. Ensure you're on the `dev` branch
3. Get VERSION from command arguments, or ask user if not provided (format: `YYYY.0.0-rc.X` or `YYYY.0.0`)
4. Validate version format matches `YYYY.0.0` or `YYYY.0.0-rc.X` or `YYYY.0.0-ballot`
5. Create a new branch named `release/v{VERSION}` from dev

### Phase 2: Update Version Information

Update version numbers in these files:

1. **package.json**:
   - Update the `version` field
   - Update `description` with version highlights and link to release notes:
     ```
     "description": "Medizininformatik Initiative - Modul Seltene Erkrankungen. Version X.X.X: [key changes]. Release Notes: https://simplifier.net/guide/mii-ig-seltene-erkrankungen-v2026-de/ReleaseNotes"
     ```
2. **sushi-config.yaml**: Update the `version` parameter
3. **input/fsh/rulesets/version.fsh**: Update version in all three RuleSets:
   - `Version` ruleset
   - `PR_CS_VS_Version` ruleset
   - `MetaProfile` ruleset
4. **guide.yaml** (Simplifier IG config): Find the latest using pattern `implementation-guides/ImplementationGuide-202*.x-DE/guide.yaml` (sort descending, pick first) and update:
   - `version` field to match new release version

IMPORTANT: Read each file first to verify current state before making changes.

### Phase 3: Run SUSHI

**CRITICAL**: After updating version files, run `sushi` to regenerate all FHIR resources with the new version. This updates the version in all StructureDefinitions and ValueSets.

```bash
sushi
```

Add all regenerated `fsh-generated/` files to the commit.

### Phase 4: Update Release Notes

1. Find release notes in appropriate location (check for `ReleaseNotes.page.md` or similar)
2. Check git log for changes since ballot/last release:
   ```bash
   git log --oneline <last-ballot-commit>..HEAD
   ```
3. Update release notes with:
   - Ballot response items (if applicable)
   - New features/profiles
   - Terminology changes
   - CI/CD improvements
   - Breaking changes

### Phase 5: Create Commit, Push, and Create PR

After all changes:
1. Stage all modified files including `fsh-generated/`
2. Create commit with message: `chore: Prepare release v{VERSION}`
3. Push release branch: `git push -u origin release/v{VERSION}`
4. Create pull request using gh CLI:
   ```bash
   gh pr create --base dev --head release/v{VERSION} --title "Release v{VERSION}" --body "Release preparation for v{VERSION}. See ReleaseNotes for details."
   ```
5. Provide the PR URL to the user

### Safety Checks

Before starting:
- Check for uncommitted changes: `git status --porcelain`
- If changes exist, offer to stash them: `git stash push -m "WIP before release" --include-untracked`
- Pull latest changes from remote

Files that should NOT be committed:
- `.bake/` (build artifacts)
- `package.bake.yaml` (local config)
- PDF files or other temporary documents

### Files to Update Checklist

- [ ] `package.json` - version and description
- [ ] `sushi-config.yaml` - version
- [ ] `input/fsh/rulesets/version.fsh` - all RuleSets
- [ ] `implementation-guides/ImplementationGuide-202*.x-DE/guide.yaml` - version (latest only)
- [ ] Release notes - changelog
- [ ] `fsh-generated/` - regenerated by sushi

## Context

The MII Module Release Workflow has 8 phases total. This command handles phases 1-4 (automated preparation). The remaining phases:
- Phase 5: Create PR and wait for CI validation
- Phase 6: Merge PR and create tag (use `/release-finalize`)
- Phase 7-8: Simplifier publishing and IG export (use `/release-simplifier`)

Refer to: https://github.com/medizininformatik-initiative/kerndatensatz-meta/wiki/Module-Release-Workflow
